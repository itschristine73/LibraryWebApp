<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Catalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

    <header class="p-5 bg-blue-600 text-white text-center">
        <a href="index.html">
        <h1 class="text-2xl font-bold">Library Catalog</h1></a>
    </header>

    <div class="p-6">
        <p id="welcome-text" class="text-gray-700"></p>

        <!-- Book Category Filter -->
        <label for="categoryFilter" class="block text-lg font-semibold">Filter by Category:</label>
        <select id="categoryFilter" class="w-84 border p-2 mb-4 rounded" onchange="loadBooks()">
            <option value="All">All</option>
            <option value="Fiction">Fiction</option>
            <option value="Non-Fiction">Non-Fiction</option>
            <option value="Science">Science</option>
            <option value="History">History</option>
            <option value="Technology">Technology</option>
        </select>
    
        <!-- Book Catalog -->
        <h2 class="text-xl font-semibold mt-4">Book Catalog</h2>
        <ul id="bookList" class="mt-2 bg-white p-4 rounded shadow"></ul>
         <!-- Modal Viewer -->
        <div id="bookViewer" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
            <div class="bg-white p-4 rounded shadow-lg w-3/4 h-3/4 flex flex-col">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Book Viewer</h2>
                    <button onclick="closeViewer()" class="text-red-600 text-lg">âœ–</button>
                </div>
                <iframe id="viewerFrame" class="flex-1 w-full h-full border mt-2"></iframe>
            </div>
        </div>


        <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 mt-4 rounded">Logout</button>
    </div>

    <script>
          async function checkSession() {
            console.log("checking sesssoion")
            try {
                console.log("started")
                const sessionId = sessionStorage.getItem('sessionId');

                const response = await fetch(`http://localhost:5000/api/users/me/${sessionId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                console.log("session checked", response)
                
                if (!response.ok) {
                    // Not logged in, redirect or show login
                    window.location.href = "login.html";
                    return;
                }

                const data = await response.json();
                console.log("User session:", data.user);

                // Use data.user as needed
                return data.user;

            } catch (error) {
                console.error("Session check failed:", error);
                window.location.href = "login.html";
            }
        }


        async function loadBooks() {
            const bookList = document.getElementById("bookList");
            bookList.innerHTML = "";

            try {
                const response = await fetch("http://localhost:5000/api/books/loadBooks");
                if (!response.ok) throw new Error("Failed to load books");

                let books = await response.json();
                const selectedCategory = document.getElementById("categoryFilter").value;

                if (selectedCategory !== "All") {
                    books = books.filter(book => book.category === selectedCategory);
                }

                if (books.length === 0) {
                    bookList.innerHTML = "<li class='text-gray-500'>No books available.</li>";
                    return;
                }

                books.forEach((book) => {
                    const card = document.createElement("div");
                    card.className = "bg-white shadow-md rounded-lg p-4 mb-4 w-full sm:w-[48%] md:w-[32%] lg:w-[24%] flex flex-col ";

                    const thumbnail = document.createElement("div");
                    thumbnail.className = "w-full h-40 bg-gray-200 flex items-center justify-center rounded mb-3";
                    thumbnail.innerHTML = `<span class="text-gray-400">ðŸ“˜</span>`;

                    const title = document.createElement("h3");
                    title.className = "text-lg font-bold text-gray-800 mb-1";
                    title.textContent = book.title;

                    const author = document.createElement("p");
                    author.className = "text-sm text-gray-600 mb-1";
                    author.innerHTML = `<strong>Author:</strong> ${book.author || 'Unknown'}`;

                    const description = document.createElement("p");
                    description.className = "text-sm text-gray-600 mb-1";
                    description.innerHTML = `<strong>Description:</strong> ${book.description || 'No description provided.'}`;

                    const uploaded = document.createElement("p");
                    uploaded.className = "text-xs text-gray-400 mb-2";
                    const date = new Date(book.created_at || Date.now());
                    uploaded.innerHTML = `<strong>Uploaded:</strong> ${date.toLocaleDateString()}`;

                    const viewBtn = document.createElement("button");
                    viewBtn.className = "mt-auto text-sm text-blue-600 hover:underline self-start";
                    viewBtn.textContent = "ðŸ“– View Book";
                    viewBtn.onclick = () => viewBook(book.id);

                    card.appendChild(thumbnail);
                    card.appendChild(title);
                    card.appendChild(author);
                    card.appendChild(description);
                    card.appendChild(uploaded);
                    card.appendChild(viewBtn);

                    bookList.appendChild(card);
                });

            } catch (error) {
                console.error("Error loading books:", error);
            }

        }

        async function viewBook(bookId) {
            try {
                const response = await fetch(`http://localhost:5000/api/books/loadBooks/${bookId}`);
                if (!response.ok) throw new Error("Failed to load book details.");

                const bookDetails = await response.json();
                const base64Content = bookDetails.file.split(',')[1]; // extract base64 part
                const mimeType = bookDetails.file.split(',')[0].match(/:(.*?);/)[1]; // extract MIME type

                // Convert base64 to binary
                const byteCharacters = atob(base64Content);
                const byteNumbers = new Array(byteCharacters.length).fill().map((_, i) => byteCharacters.charCodeAt(i));
                const byteArray = new Uint8Array(byteNumbers);

                // Create a Blob from the binary data
                const blob = new Blob([byteArray], { type: mimeType });

                // Create a temporary object URL
                const url = URL.createObjectURL(blob);

                // Open the blob in a new tab
                window.open(url, "_blank");

                // Optional: Revoke the object URL after some time to free memory
                setTimeout(() => URL.revokeObjectURL(url), 10000);
            } catch (error) {
                console.error("Error loading book:", error);
                alert("Failed to open book.");
            }
        }
        
        async function logout() {
            try {
                await fetch('http://localhost:5000/api/users/logout', {
                    method: 'POST',
                    credentials: 'include' // Important for sending session cookie
                });

                // Optionally clear frontend state too
                sessionStorage.removeItem("sessionId");

                // Redirect
                window.location.href = "login.html";
            } catch (error) {
                console.error('Logout failed:', error);
                alert("Failed to logout. Try again.");
            }
        }


        // checkLogin();
        loadBooks();
        window.addEventListener('DOMContentLoaded', async () => {
            const user = await checkSession();
        });
    </script>

</body>
</html>
